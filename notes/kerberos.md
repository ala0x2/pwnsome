# Kerberos

- Network authentication protocol.
- Adds a third component (Key Distribution Center) to the server-client architecture (hence, the reference to Cerberus).
- Uses symmetric-key cryptography based on `tickets`.
- Implemented in Windows under the name `MS-KILE` to replace NTLM.
- Uses hostnames instead of IP addresses for connections.
- `krbtgt` account is used to encrypt/sign Kerberos tickets.
- Uses ports UDP/88 and TCP/88.

## Further details

- [Kerberos: The Network Authentication Protocol](http://web.mit.edu/kerberos/)

# How it works

- [Kerberos Explained (In 3 Levels Of Detail) - VbScrub](https://youtu.be/snGeZlDQL2Q)

# Getting around Kerberos

## ASREPRoasting

- If Kerberos pre-authentication is not required (`DONT_REQ_PREAUTH` attribute is set) for a user, anyone can send an `AS_REQ` to the DC on behalf of him.
- `AS_REP` messages contain data encrypted with the user's password which can be cracked offline.

```powershell
Get-DomainUser -PreauthNotRequired -verbose # Enumeration
```
```bash
python GetNPUsers.py # impacket
```
## Further details

- [Roasting AS-REPs](https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/)

## Golden ticket

- Gaining acces to the `krbtgt` allows an attacker to forge a valid TGT as any user.
- `AS-REP` messages contain data encrypted with `krbtgt` account password but the chance of it being cracked offline is low (strong password generated by AD).
- `krbtgt`'s account NTLM hash can be obtain from the `NTDS.dit` file or the `lsass.exe` process if the attacker has the required privileges.

## Silver ticket

- Gaining acces to the a service account allows an attacker to forge a valid TGS for the service as any user.
- Computer accounts passwords are reset every 30 by default.

## Kerberoasting

- An SPN (Service Principal Name) is an attribute that contains ServiceName/MachineItRunsOn.
- Usually services are run using computer accounts which have long complex passwords managed by AD.
- If a user account is used to run a service, there's a chance that it has a weak password (manually set).
- Any user of the domain can ask for a TGS that contains data encrypted with the service's account password which can be cracked offline.
```
GetUsernsSPN.py hermes.local/user:p@ss 
GetUsernsSPN.py hermes.local/user:p@ss -request # get TGS
```
```
hashcat -m 13100 "<TGS ticket>" rockyou.txt
```

### Mitigation

- Password Hardening.
- Using Managed Service Accounts (Password and SPN managed by AD).